let img = 'data:image/png;base64,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';

const SPEC = (() => {
    const SPRITES = `
id  |x|y |w |h |note
t0  |0|0 |7 |  |tail side view
j0  |1|0 |20|  |articulated junction (280)
a   |2|  |  |17|axels
a0  | |0 |16|  |pneumatic rear
a1  | |1 |17|  |springs rear (255, 266)
a2  | |2 |15|  |ifa rear (211)
a3  | |3 |16|  |pneumatic front
a4  | |4 |17|  |springs front (255, 266)
a5  | |5 |15|  |ifa front (211)
w   |3|  |  |21|windows
w0  | |0 |25|  |sliderless
w1  | |1 |25|  |small sliders
w2  | |2 |25|  |large sliders
w3  | |3 |16|  |narrow
w4  | |4 |14|  |narrow sliderless
w5  | |5 |16|  |short, narrow
w6  | |6 |7 |  |tiny
w7  | |7 |30|  |wide sliderless (255.72)
w8  | |8 |30|  |wide
l   |4|  |  |17|hatches
l0  | |0 |20|  |tall
l1  | |1 |20|  |batt. (260.50)
l2  | |2 |20|  |short
l3  | |3 |20|  |fuel tank (260.50)
l4  | |4 |13|  |exhaust grill
l5  | |5 |13|  |radiator grill
l00 | |9 |39|  |double
l000| |10|58|  |tripple
l6  | |11|39|  |engine
d   |5|  |  |  |doors
d0  | |0 |16|  |hinged tall (255.72)
d1  | |1 |16|  |hinged short  (256.54)
d2  | |2 |16|  |sliding rear (250.59)
d3  | |3 |16|  |sliding front (250.59)
d4  | |4 |22|  |folding front (260.50)
d5  | |5 |22|  |gliding (280.64)
d6  | |6 |24|  |gliding wide (263.00)
d7  | |7 |22|  |folding (260.50)
d8  | |8 |16|  |steyr (old 256)
d9  | |9 |16|  |folding front (266)
h   |6|  |7 |  |head side view
h0  | |0 |  |  |steel bumper
h1  | |1 |  |  |plastic bumper (250.59)
f   |7|  |  |  |frontal view
f0  | |0 |42|  |2 headlamps
f1  | |1 |42|  |4 headlamps
f2  | |2 |42|  |plastic bumper (250.59)
r   |8|  |  |  |rearside view
r0  | |0 |38|  |engine underflor
r1  | |1 |38|  |rear engine
s   |9|  |16|  |roof elements
s0  | |0 |  |  |blind
s1  | |1 |  |  |wide hatch
s2  | |2 |  |  |hatch
s3  | |3 |  |  |vent
s4  | |4 |10|  |front
s5  | |5 |9 |  |rear
`.split('\n')
        .filter(v => v && '' !== v.trim())
        .slice(1)
        .map(l => l.split('|').map(v => v.trim()))
        .map(([id, x, y, w, h, note]) => [id, {x, y, w, h, note, baseline: 'al'.indexOf(id[0]) >= 0 ? 'bottom' : 'top'}]);

    const LIVREYS = `
id|gradient                                                                 |note
c1|#E19000  0px 42px,   transparent 42px                                    |RAL 1006
c2|white    10px 20px,  #3B77B3 20px 32px, white 32px 42px, transparent 42px|DDR
c3|#e6d2b5  10px 30px,  rgb(134,26,34) 30px 42px, transparent 42px          |USSR 255
c4|blue     30px,  #e6d2b5 30px 42px, transparent 42px                 |dark blue
c5|rgb(134,26,34) 10px 30px, #e6d2b5 30px 42px, transparent 42px            |USSR 250
c6|#cc3300  10px 30px,  #e6d2b5 30px 42px, transparent 42px                 |250.59
c7|white    10px 30px,  #3B77B3 30px 42px, transparent 42px                 |cyan bottom
c8|#FCE10B  10px 30px,  #F62803 30px 42px, transparent 42px                 |Warszawa
`.split('\n')
        .filter(v => v && '' !== v.trim())
        .slice(1)
        .map(l => l.split('|').map(v => v.trim()))
        .map(([id, rules, note]) => [id, { rules, note }]);

    const _var = { dx: -42, dy: -47 };
    const cache = {};
    
    function _genSpritesCSS() {
        return SPRITES.map(([id, { x, y, w, h, baseline, note }]) => {
            const selector = `:checked[value${1 < id.length ? '' : '^'}="${id}"] ~ .shadow .${baseline}, .${id}`;
            const xexpr = x !== '0' ? `calc(var(--dx)${x === 1 ? '' : ` * ${x}`} - 1px)` : x;
            const yexpr = y !== '0' 
                ? `calc(var(--dy)${y === 1 ? '' : ` * ${y}`}${baseline === 'bottom' ? ' - 29px' : ''})` 
                : baseline === 'bottom' ? '-29px' : y;

            const rules = [
                x && y 
                    ? `background-position: ${xexpr} ${yexpr}`
                    : x 
                        ? `background-position-x: ${xexpr}`
                        : y 
                            ? `background-position-y: ${yexpr}` 
                            : '',
                w && `width: ${w}px`,
                h && `min-height: ${h}px`
            ].filter(Boolean); // Directly filters falsy values like empty strings

            return rules.length ? `${selector} { ${rules.join('; ')}; }/* ${note} */` : '';
        }).filter(Boolean).join('\n'); // Filters out empty results and joins rules
    }
    
    function _genInlineSprites() {
        return SPRITES.reduce((acc, [id, { x, y, w, baseline }]) => {
            const xexpr = `${_var.dx * x - 1}px`;
            const yexpr = `${_var.dy * y}${y > 0 ? 'px' : ''}`;
            
            const rules = [
                baseline !== 'bottom' ? '/*top*/' : '',
                x && y ? `background-position: ${xexpr} ${yexpr}` :
                x ? `background-position-x: ${xexpr}` :
                y ? `background-position-y: ${yexpr}` : '',
                w ? baseline === 'bottom' 
                    ? `padding-left: ${w}px; margin-left: ${-w}px` 
                    : `padding-right: ${w}px` : ''
            ].filter(Boolean); // Removes falsy values directly

            if (rules.length) {
                acc[id] = rules.join('; ') + ';';
            }
            return acc;
        }, {});
    }
    
    const imgType = Object.freeze({
        inline: img,
        file: 'tiles.png'
    });
    
    return {
        imgType,
        get ["bus.sprites.css"]() {
            return cache["bus.sprites.css"] ??= _genSpritesCSS();
        },
        get sprites() {
            return cache['sprites'] ??= {
                _: `background-image: url(${imgType.file})/*livrey*/; font-size: 0; line-height: 47px;`,
                ..._genInlineSprites()
            };
        },
        get ["bus.gradients.css"]() {
            return cache['bus.gradients.css'] ??= LIVREYS.map(([id, {rules, note}]) =>`\
.${id},:checked[value="${id}"] ~ div .slot .shadow label { background-image: linear-gradient(to bottom, ${rules}); } /* ${note} */`).join('\n');
        },
        get livreys() {
            return cache['livreys'] ??= Object.fromEntries(
                LIVREYS.map(([id, { rules }]) => [id, `linear-gradient(to bottom, ${rules});`])
            );
        },
        get hints() {
            return cache['hints'] ??= Object.fromEntries(
                [...LIVREYS, ...SPRITES].map(([id, { note }]) => [id, note])
            );
        },
        SPRITES
    }
})();

const BUS = showBus;

//const groupped_rx = /([dhfrtw])(\d+)\s*(?:([acl])(\d+))?/g;

function showBus(bus = genesys['bus0'], visitors = [consoleVisitor], id) {
    const colorElement = bus.match(/c\d+/g)?.[0] ?? 'c1';
    const slice = [
        ...bus
            //.split(/(?<=h\d+)/g)[0]///Stops at right side of the bus.
            .match(/\w\d+/g)
            .filter(part => !part.startsWith('c')),
        colorElement
    ];
    
    const styles = slice.map((curr, index) => {
        let newRules = (SPEC.sprites[curr[0]] || '') + SPEC.sprites[curr];
        const isTopItem = 0 <= newRules.indexOf('/*top*/');

        if (!isTopItem && index > 0) {
            const prev = slice[index - 1];
            if (prev) {
                const [prevWidth, currWidth] = [
                    (SPEC.sprites[prev]?.match(/padding-right:\s*(\d+)px/) || [])[1],
                    (newRules.match(/padding-left:\s*(\d+)px/) || [])[1]
                ].map(Number);
                const leftShift = Math.round(Math.max((prevWidth + currWidth) / 2, currWidth));
                newRules = newRules
                    .replace(/margin-left:\s*(-?\d+)px;/, `margin-left: ${-leftShift}px;`)
                    .replace(/padding-left:\s*(\d+)px;/, `padding-left: ${leftShift}px;`);
            }
        }
        
        return SPEC.sprites._.replace(
            '/*livrey*/',
            isTopItem ? `, ${SPEC.livreys[colorElement]}` : ''
        ) + newRules;
    });

    return visitors.map(visitor => visitor(slice, styles, id));
}

function consoleVisitor(slice, styles) {
    console.log(
        slice.map(a => `%c${a}`).join(' '),
        ...styles.map(rules => rules.replace(SPEC.imgType.file, SPEC.imgType.inline))
    );
}

function defaultDelegateFactory() {
    return function(html) {
        return `<div class='bus-view'>${html}</div>`;
    };
}

/**
 * Keep styles inline with respective span, inflicting a lot of overhead.
 */
function htmlVisitorInlineFactory(delegate = defaultDelegateFactory()) {
    return function(slice, styles, id) {
        const html = slice
            .map((a, index) =>
                'c' === a[0]
                    ? a
                    : `<span class="${a[0]} ${a}" style="width: unset; display:inline-block; ${styles[index]}">${a}</span>`
            )
            .join(' ');

        return delegate(html, slice, styles, id);
    };
}

/**
 * Isolates CSS rules into bus-scoped <style/> block, allowing for optinmization.
 */
function htmlVisitorOutlineFactory(delegate = defaultDelegateFactory()) {
    return function (slice, styles, id) {
        const styleSheet = [];
        let prevClass = "";
        
        const colorElement = slice.find(a => 'c' == a[0]);
        
        const html = slice
            .map((a, index) => {
                if (a[0] === 'c') return a; // Preserve content elements
                const rules = styles[index];
                const isTopItem = 0 <= rules.indexOf('/*top*/');
                const className = `${a[0]}.${a}`;
                const selector = prevClass && !isTopItem ? `#${id} .${prevClass} + .${className}` : `#${id} .${className}`;

                styleSheet.push(`${selector} { ${rules + (isTopItem ? '' : '; background-image: url(tiles.png); ')} }`);
                prevClass = className; // Update previous class for the next iteration

                return `<span class="${a[0]} ${a} ${colorElement}">${a}</span>`;
            })
            .join(' ');
        
        const livreyCss = colorElement ? SPEC.sprites._.replace('/*livrey*/', `, ${SPEC.livreys[colorElement]}`) : SPEC.sprites._;
        
        styleRules = [...new Set(styleSheet)]
            .join('\n')
            .replaceAll('/*top*/', '')
            .replaceAll(livreyCss, '')
            .replaceAll(SPEC.sprites._.replace('/*livrey*/', ''), '');
        
        const styleTag = `<style>\n#${id} span { width: unset; display:inline-block; ${livreyCss}}\n${styleRules}</style>\n`.replaceAll(';;', ';');

        return delegate(html, slice, styles, id, styleTag);
    };
}

/**
 * Renders bus as a single strip of parts.
 */
function flatRenderer(html, slice, styles, id, styleTag) {
    return $("<a class='bus-view' />")
        .html(styleTag + html)
        .attr('href', '#' + encodeURIComponent($(`<span>${html}</span>`).text().replace(/\s+/g, '')));
}

/**
 * Renders bus in 3D.
 */
function fullRenderer(html, slice, styles, id, styleTag) {
    const $html = $(`<div>${html}</div>`);
    const bus = $html.text();
    return $("<a class='bus-view paper-net' />")
        .append(
            styleTag,
            splitSides($html),
            html.match(/c\d+/)?.[0] ?? "c1")
        .attr("href", "#" + encodeURIComponent(bus.replace(/\s+/g, "")));
}

/**
 * Takes linear markup of either bus editor or viewer and splits it into 4 sides each wrapped in <div/>.
 */
function splitSides($html) {
    const sel = selector => `.slot:has(:checked[value^="${selector}"]), >span.${selector}`;
    const getSplitPoint = (selector) => $html.find(sel(selector)).first();
    
    const firstHead = getSplitPoint('h');
    const secondHead = $html.find(sel('h')).eq(1);
    const nextTail = secondHead.nextAll(sel('t')).first();
        
    const sections = [
        $html.find(`.slot, >span`).slice(0, firstHead.index() + 1),
        getSplitPoint('f'),
        secondHead.add(secondHead.nextUntil(nextTail).add(nextTail)),
        getSplitPoint('r'),
    ];
    
    return ['right', 'front', 'left', 'rear'].map((side, i) => 
            sections[i]?.length && $("<div/>", { class: `${side} face` }).html(sections[i])
        ).filter(Boolean);
}

function parseAnnotations(docs) {
    const graph = {};

    docs.forEach(doc => {
        const name = doc.match(/function (\w+)/)?.[1];
        const depends = [...doc.matchAll(/@depends (\w+)/g)].map(match => match[1]);
        const usedBy = [...doc.matchAll(/@usedBy (\w+)/g)].map(match => match[1]);

        if (name) {
            graph[name] = { depends, usedBy };
        }
    });

    return graph;
}